<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saha Takip</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .transition-height { transition: max-height 0.3s ease-in-out, padding 0.3s ease; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans pb-24">

    <!-- Header -->
    <div class="bg-white shadow-md sticky top-0 z-50 border-b border-slate-200">
        <div class="max-w-2xl mx-auto p-4">
            <div class="flex justify-between items-center mb-2">
                <div>
                    <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="pie-chart" class="w-6 h-6 text-blue-600"></i>
                        Saha Takip
                    </h1>
                    <span class="text-xs text-slate-500">Toplam 41 Eczane</span>
                </div>
                
                <div class="flex flex-col items-end gap-0.5">
                    <div class="flex items-center gap-1.5 text-green-600 bg-green-50 px-2 py-0.5 rounded-md border border-green-100">
                        <span class="text-sm font-bold">â‚º</span>
                        <span id="total-amount" class="text-lg font-bold tracking-tight">0</span>
                    </div>
                    <div class="flex items-baseline gap-2 mt-1">
                        <span id="visit-count" class="text-[10px] text-slate-400 font-medium tracking-wide">0 / 41 Ziyaret</span>
                        <span id="visit-percentage" class="text-base font-black text-blue-600">%0</span>
                    </div>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="w-full bg-slate-200 rounded-full h-3 overflow-hidden">
                <div id="progress-bar" class="bg-blue-600 h-3 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app-container" class="max-w-2xl mx-auto p-4 space-y-4">
        <!-- Eczane listesi buraya JS ile doldurulacak -->
    </div>

    <!-- Footer -->
    <div class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-slate-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-50">
        <div class="max-w-2xl mx-auto flex gap-3">
            <button onclick="copyReport()" class="flex-1 bg-slate-800 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 active:bg-slate-900 shadow-md">
                <i data-lucide="clipboard-copy" class="w-5 h-5"></i>
                Raporu Kopyala
            </button>
            <button onclick="confirmReset()" class="bg-red-50 text-red-600 px-4 rounded-lg font-bold border border-red-100 active:bg-red-100 flex items-center justify-center">
                <i data-lucide="refresh-ccw" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <script>
        // Veri Seti
        const RAW_DATA = [
            { gln: "8680001156580", name: "FATÄ°H ECZANESÄ°", region: "ORDU MERKEZ -1" },
            { gln: "8680001203062", name: "ÅžÄ°MÅžEK ECZANESÄ°", region: "ORDU MERKEZ -1" },
            { gln: "8680001165636", name: "KAYAHAN ECZANESÄ°", region: "ORDU MERKEZ -1" },
            { gln: "8680001154135", name: "ERGÃœL ECZANESÄ°", region: "ORDU MERKEZ -1" },
            { gln: "8680001554102", name: "ALTINORDU ECZANESÄ°", region: "ORDU MERKEZ -1" },
            { gln: "8680001428342", name: "DOÄžA ECZANESÄ°", region: "ORDU MERKEZ -1" },
            { gln: "8680001627868", name: "GÃœNEÅž ECZANESÄ°", region: "ORDU MERKEZ -1" },
            { gln: "8680001148165", name: "NAZ ECZANESÄ°", region: "ORDU MERKEZ -2" },
            { gln: "8680001150304", name: "ORDU ECZANESÄ°", region: "ORDU MERKEZ -2" },
            { gln: "8680001141944", name: "KOÃ‡YÄ°ÄžÄ°T ECZANESÄ°", region: "ORDU MERKEZ -2" },
            { gln: "8680001153336", name: "DURU ECZANESÄ°", region: "ORDU MERKEZ -3" },
            { gln: "8680001420681", name: "ONUR ECZANESÄ°", region: "ORDU MERKEZ -3" },
            { gln: "8680001494163", name: "ZEYNEP ECZANESÄ°", region: "ORDU MERKEZ -3" },
            { gln: "8680001570485", name: "FIRAT ECZANESÄ°", region: "ORDU MERKEZ -3" },
            { gln: "8680001563258", name: "MERT GERÃ‡EKER ECZ.", region: "ORDU MERKEZ -3" },
            { gln: "8680001632466", name: "TUGCAN ECZANESI", region: "ORDU MERKEZ -3" },
            { gln: "8680001679072", name: "NÄ°SAN ECZANESÄ°", region: "ORDU MERKEZ -3" },
            { gln: "8680001648450", name: "AÅžKAN ECZANESÄ°", region: "ORDU MERKEZ -3" },
            { gln: "8680001141746", name: "ALTAÅž ECZANESÄ°", region: "ORDU MERKEZ -3" },
            { gln: "8680001636570", name: "Ã‡Ã–REK OTU ECZANESÄ°", region: "ORDU FATSA" },
            { gln: "8680001277230", name: "MERKEZ ECZANESÄ°", region: "ORDU FATSA" },
            { gln: "8680001252817", name: "AKAR ECZANESÄ°", region: "ORDU FATSA" },
            { gln: "8680001389414", name: "BESTE ECZANESÄ°", region: "ORDU FATSA" },
            { gln: "8680001490844", name: "FATSA ECZANESÄ°", region: "ORDU FATSA" },
            { gln: "8680001277308", name: "NOKTA ECZANESÄ°", region: "ORDU FATSA" },
            { gln: "8680001417810", name: "Ã‡AKIROÄžLU ECZANESÄ°", region: "ORDU UNYE" },
            { gln: "8680001232352", name: "TELCÄ°OÄžLU ECZANESÄ°", region: "ORDU UNYE" },
            { gln: "8680001150144", name: "ORAL ECZANESÄ°", region: "ORDU UNYE" },
            { gln: "8680001657612", name: "NEFES ECZANESÄ°", region: "ORDU UNYE" },
            { gln: "8680001163564", name: "KARADENÄ°Z ECZANESÄ°", region: "ORDU DOGU ILCELER" },
            { gln: "8680001163717", name: "KARADENÄ°Z ECZANESÄ° (2)", region: "ORDU DOGU ILCELER" },
            { gln: "8680001460397", name: "IRMAK ECZANESÄ°", region: "ORDU DOGU ILCELER" },
            { gln: "8680001713677", name: "YENÄ° MEDRESEÃ–NÃœ ECZ.", region: "ORDU DOGU ILCELER" },
            { gln: "8680001213276", name: "MESUDÄ°YE ECZANESÄ°", region: "ORDU DOGU ILCELER" },
            { gln: "8680001726905", name: "DEVA ECZANESÄ°", region: "ORDU DOGU ILCELER" },
            { gln: "8680001202294", name: "ÅžAHÄ°N ECZANESÄ°", region: "ORDU DOGU ILCELER" },
            { gln: "8680001233144", name: "ULUBEY ECZANESÄ°", region: "ORDU DOGU ILCELER" },
            { gln: "8680001709571", name: "LOTUS ECZANESÄ°", region: "ORDU DOGU ILCELER" },
            { gln: "8680001753178", name: "LOTUS ECZANESÄ° (2)", region: "ORDU DOGU ILCELER" },
            { gln: "8680001428854", name: "Ã‡AÄžLA ECZANESÄ°", region: "ORDU DOGU ILCELER" },
            { gln: "8680001157914", name: "GÃœRGENTEPE ECZANESÄ°", region: "ORDU GUNEY ILCELER -1" }
        ];

        // State YÃ¶netimi
        let trackingData = JSON.parse(localStorage.getItem('eczaneTakipGitHubV2')) || {};
        let expandedRegions = {};
        let expandedDetails = {};

        // Veriyi Kaydet
        function saveData() {
            localStorage.setItem('eczaneTakipGitHubV2', JSON.stringify(trackingData));
            renderApp();
        }

        // Gruplama Fonksiyonu
        function getGroupedData() {
            const groups = {};
            RAW_DATA.forEach(item => {
                if (!groups[item.region]) groups[item.region] = [];
                groups[item.region].push(item);
            });
            return groups;
        }

        // YardÄ±mcÄ± Fonksiyonlar
        function toggleRegion(region) {
            expandedRegions[region] = !expandedRegions[region];
            renderApp();
        }

        function toggleDetails(gln) {
            expandedDetails[gln] = !expandedDetails[gln];
            renderApp();
        }

        function updateData(gln, field, value) {
            if (!trackingData[gln]) trackingData[gln] = {};
            trackingData[gln][field] = value;
            saveData();
        }

        function toggleStatus(gln, type) {
            if (!trackingData[gln]) trackingData[gln] = { visited: false, ordered: false };
            trackingData[gln][type] = !trackingData[gln][type];
            
            // EÄŸer sipariÅŸ alÄ±ndÄ±ysa, ziyaret edilmiÅŸ de sayÄ±lÄ±r
            if (type === 'ordered' && trackingData[gln].ordered && !trackingData[gln].visited) {
                trackingData[gln].visited = true;
            }
            saveData();
        }

        function toggleFollowUp(gln, type) {
            if (!trackingData[gln]) trackingData[gln] = {};
            trackingData[gln].followUp = trackingData[gln].followUp === type ? '' : type;
            saveData();
        }

        function confirmReset() {
            if(confirm("TÃ¼m ziyaret, sipariÅŸ ve notlar silinecek. Emin misin?")) {
                localStorage.removeItem('eczaneTakipGitHubV2');
                trackingData = {};
                location.reload();
            }
        }

        function copyReport() {
            let visitedCount = 0, orderedCount = 0, totalAmount = 0;
            const totalCount = RAW_DATA.length;

            Object.values(trackingData).forEach(item => {
                if (item.visited) visitedCount++;
                if (item.ordered) {
                    orderedCount++;
                    totalAmount += parseFloat(item.amount) || 0;
                }
            });

            const visitPercentage = Math.round((visitedCount / totalCount) * 100);

            let report = `ðŸ“… *GÃ¼nlÃ¼k Saha Raporu*\n\n`;
            report += `ðŸ“ˆ Ziyaret: %${visitPercentage} (${visitedCount}/${totalCount})\n`;
            report += `ðŸ“¦ SipariÅŸ SayÄ±sÄ±: ${orderedCount}\n`;
            report += `ðŸ’° Ciro: ${totalAmount.toLocaleString('tr-TR')} TL\n\n`;
            
            report += `*SipariÅŸ AlÄ±nanlar:*\n`;
            let orderLines = [];
            RAW_DATA.forEach(item => {
                const data = trackingData[item.gln];
                if (data?.ordered) {
                    let line = `- ${item.name}`;
                    if (data.amount) line += ` (${parseFloat(data.amount).toLocaleString('tr-TR')} TL)`;
                    if (data.note) line += ` | Not: ${data.note}`;
                    orderLines.push(line);
                }
            });
            report += orderLines.length > 0 ? orderLines.join('\n') : "Yok\n";

            report += `\n*Takip / Durumlar:*\n`;
            let followUpLines = [];
            RAW_DATA.forEach(item => {
                const data = trackingData[item.gln];
                if (!data?.ordered && (data?.followUp || data?.note)) {
                    let line = `- ${item.name}`;
                    if (data.followUp === 'later') line += ` [Sonra UÄŸra]`;
                    if (data.followUp === 'waiting') line += ` [DÃ¶nÃ¼ÅŸ Bekleniyor]`;
                    if (data.note) line += ` | Not: ${data.note}`;
                    followUpLines.push(line);
                }
            });
            report += followUpLines.length > 0 ? followUpLines.join('\n') : "Yok\n";

            navigator.clipboard.writeText(report).then(() => {
                alert("Rapor kopyalandÄ±!");
            });
        }

        // Ana Render Fonksiyonu
        function renderApp() {
            const container = document.getElementById('app-container');
            const groupedData = getGroupedData();
            
            // Ä°statistik Hesapla
            let visitedCount = 0, orderedCount = 0, totalAmount = 0;
            Object.values(trackingData).forEach(item => {
                if (item.visited) visitedCount++;
                if (item.ordered) {
                    orderedCount++;
                    totalAmount += parseFloat(item.amount) || 0;
                }
            });
            
            const visitPercentage = Math.round((visitedCount / RAW_DATA.length) * 100);

            // Header Update
            document.getElementById('total-amount').innerText = totalAmount.toLocaleString('tr-TR');
            document.getElementById('visit-count').innerText = `${visitedCount} / ${RAW_DATA.length} Ziyaret`;
            document.getElementById('visit-percentage').innerText = `%${visitPercentage}`;
            document.getElementById('progress-bar').style.width = `${visitPercentage}%`;

            // Listeyi Temizle ve Yeniden Kur
            container.innerHTML = '';

            for (const [region, items] of Object.entries(groupedData)) {
                // BÃ¶lge Ä°statistikleri
                let regionVisited = 0;
                items.forEach(i => { if (trackingData[i.gln]?.visited) regionVisited++; });
                const isAllVisited = regionVisited === items.length && items.length > 0;
                const isOpen = expandedRegions[region];

                const regionHtml = document.createElement('div');
                regionHtml.className = "bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden";
                
                // BÃ¶lge BaÅŸlÄ±ÄŸÄ±
                regionHtml.innerHTML = `
                    <button onclick="toggleRegion('${region}')" class="w-full flex justify-between items-center p-4 transition-colors ${isAllVisited ? 'bg-green-50' : 'bg-white hover:bg-slate-50'}">
                        <div class="text-left">
                            <h3 class="font-bold ${isAllVisited ? 'text-green-700' : 'text-slate-800'}">${region}</h3>
                            <p class="text-xs text-slate-500 mt-1">${items.length} Eczane â€¢ ${regionVisited} Ziyaret</p>
                        </div>
                        <i data-lucide="${isOpen ? 'chevron-up' : 'chevron-down'}" class="text-slate-400 w-5 h-5"></i>
                    </button>
                `;

                if (isOpen) {
                    const listContainer = document.createElement('div');
                    listContainer.className = "divide-y divide-slate-100 bg-slate-50/50";

                    items.forEach(pharmacy => {
                        const data = trackingData[pharmacy.gln] || {};
                        const isDetailsOpen = expandedDetails[pharmacy.gln];

                        // Rozetler
                        let badges = '';
                        if (!isDetailsOpen) {
                            if (data.followUp === 'later') badges += `<span class="bg-orange-100 text-orange-700 text-[9px] px-1.5 py-0.5 rounded font-bold ml-2">SONRA</span>`;
                            if (data.followUp === 'waiting') badges += `<span class="bg-purple-100 text-purple-700 text-[9px] px-1.5 py-0.5 rounded font-bold ml-2">DÃ–NÃœÅž</span>`;
                        }

                        // Tutar GÃ¶stergesi (Liste KapalÄ±yken)
                        let amountDisplay = '';
                        if (data.ordered && data.amount && !isDetailsOpen) {
                            amountDisplay = `<div class="mt-1 text-xs font-bold text-green-600">â‚º${parseFloat(data.amount).toLocaleString('tr-TR')}</div>`;
                        }

                        const itemDiv = document.createElement('div');
                        itemDiv.className = "flex flex-col";
                        itemDiv.innerHTML = `
                            <div class="p-3 flex items-start justify-between gap-3 bg-white">
                                <div class="flex-1 min-w-0 pt-1">
                                    <div class="flex items-center flex-wrap">
                                        <div class="font-semibold truncate ${data.visited ? 'text-slate-600' : 'text-slate-900'}">${pharmacy.name}</div>
                                        ${badges}
                                    </div>
                                    <div class="text-[10px] text-slate-400 font-mono">GLN: ${pharmacy.gln}</div>
                                    ${amountDisplay}
                                </div>
                                
                                <div class="flex gap-2 shrink-0">
                                    <button onclick="toggleStatus('${pharmacy.gln}', 'visited')" class="flex flex-col items-center justify-center w-11 h-11 rounded-lg border transition-all active:scale-95 ${data.visited ? 'bg-green-100 border-green-200 text-green-700 shadow-inner' : 'bg-white border-slate-200 text-slate-400 shadow-sm'}">
                                        <i data-lucide="check-circle-2" class="w-5 h-5 mb-0.5"></i>
                                        <span class="text-[8px] font-bold">GÄ°TTÄ°M</span>
                                    </button>
                                    
                                    <button onclick="toggleStatus('${pharmacy.gln}', 'ordered')" class="flex flex-col items-center justify-center w-11 h-11 rounded-lg border transition-all active:scale-95 ${data.ordered ? 'bg-blue-100 border-blue-200 text-blue-700 shadow-inner' : 'bg-white border-slate-200 text-slate-400 shadow-sm'}">
                                        <i data-lucide="shopping-cart" class="w-4 h-4 mb-0.5"></i>
                                        <span class="text-[8px] font-bold">SÄ°PARÄ°Åž</span>
                                    </button>

                                    <button onclick="toggleDetails('${pharmacy.gln}')" class="flex flex-col items-center justify-center w-8 h-11 rounded-lg border transition-all active:scale-95 ${isDetailsOpen || data.note || data.followUp ? 'bg-slate-100 border-slate-300 text-slate-700' : 'bg-white border-slate-200 text-slate-400'}">
                                        <i data-lucide="file-text" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="bg-slate-50 px-3 border-b border-slate-100 overflow-hidden transition-height ${data.ordered || isDetailsOpen ? 'pb-2 max-h-96' : 'max-h-0 border-0'}">
                                ${data.ordered ? `
                                    <div class="pt-2">
                                        <div class="relative">
                                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 font-bold text-sm">â‚º</span>
                                            <input type="number" placeholder="Tutar giriniz" value="${data.amount || ''}" oninput="updateData('${pharmacy.gln}', 'amount', this.value)" class="w-full pl-8 pr-3 py-2 text-sm border border-blue-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white shadow-sm">
                                        </div>
                                    </div>
                                ` : ''}

                                ${isDetailsOpen ? `
                                    <div class="space-y-2 pt-2">
                                        <div class="flex gap-2">
                                            <button onclick="toggleFollowUp('${pharmacy.gln}', 'later')" class="flex-1 flex items-center justify-center gap-1 py-1.5 px-2 rounded border text-[11px] font-bold transition-colors ${data.followUp === 'later' ? 'bg-orange-100 border-orange-200 text-orange-700' : 'bg-white border-slate-200 text-slate-500'}">
                                                <i data-lucide="clock" class="w-3 h-3"></i> Sonra UÄŸra
                                            </button>
                                            <button onclick="toggleFollowUp('${pharmacy.gln}', 'waiting')" class="flex-1 flex items-center justify-center gap-1 py-1.5 px-2 rounded border text-[11px] font-bold transition-colors ${data.followUp === 'waiting' ? 'bg-purple-100 border-purple-200 text-purple-700' : 'bg-white border-slate-200 text-slate-500'}">
                                                <i data-lucide="alert-circle" class="w-3 h-3"></i> DÃ¶nÃ¼ÅŸ Bekleniyor
                                            </button>
                                        </div>
                                        <textarea placeholder="Not ekleyin..." oninput="updateData('${pharmacy.gln}', 'note', this.value)" class="w-full p-2 text-sm border border-slate-200 rounded-md focus:outline-none focus:ring-2 focus:ring-slate-400 bg-white min-h-[60px]">${data.note || ''}</textarea>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                        listContainer.appendChild(itemDiv);
                    });
                    regionHtml.appendChild(listContainer);
                }
                container.appendChild(regionHtml);
            }
            lucide.createIcons();
        }

        // BaÅŸlat
        renderApp();
    </script>
</body>
</html>
