<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Genveon Kampanya V6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Inter:wght@400;500;600;700;800&display=swap');
        
        body { -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; }
        .font-brand { font-family: 'Playfair Display', serif; }
        .transition-height { transition: max-height 0.3s ease-in-out, padding 0.3s ease; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 pb-40">

    <!-- Header -->
    <div class="bg-white shadow-sm sticky top-0 z-40 border-b border-slate-200">
        <div class="max-w-2xl mx-auto px-4 py-3">
            <div class="flex justify-between items-end mb-3">
                <!-- LOGO ALANI -->
                <div>
                    <h1 class="font-brand font-black text-2xl tracking-tighter text-black leading-none uppercase">
                        GENVEON
                    </h1>
                    <span class="text-[10px] font-sans font-bold tracking-[0.2em] text-slate-500 uppercase ml-0.5">Kampanya Takip</span>
                </div>
                
                <div class="flex flex-col items-end gap-1.5">
                    <!-- Üst Bilgi Grubu -->
                    <div class="flex gap-2">
                        <!-- Dalin Hedef -->
                        <div class="flex items-center gap-1.5 bg-yellow-50 px-2 py-1 rounded border border-yellow-200 text-yellow-800">
                            <span class="text-[10px] font-bold uppercase tracking-wider">DALİN</span>
                            <div class="flex items-baseline">
                                <span id="dalin-total" class="text-base font-black">0</span>
                                <span class="text-[10px] font-bold text-yellow-600">/5</span>
                            </div>
                        </div>

                        <!-- Ciro -->
                        <div class="flex items-center gap-1 text-slate-800 bg-slate-100 px-2 py-1 rounded border border-slate-200">
                            <span class="text-xs font-bold text-slate-500">₺</span>
                            <span id="total-amount" class="text-base font-black tracking-tight">0</span>
                        </div>
                    </div>

                    <!-- Yüzde -->
                    <div class="flex items-baseline gap-1">
                        <span id="visit-count" class="text-[10px] text-slate-400 font-medium">0/0</span>
                        <span id="visit-percentage" class="text-sm font-black text-black">%0</span>
                    </div>
                </div>
            </div>
            
            <!-- Renkli Progress Bar -->
            <div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                <div id="progress-bar" class="h-2.5 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app-container" class="max-w-2xl mx-auto p-4 space-y-4">
        <!-- Liste buraya JS ile dolacak -->
    </div>

    <!-- Footer Action Bar -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-50">
        <div class="max-w-2xl mx-auto p-3 space-y-2">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="openAddModal()" class="bg-black text-white py-3 rounded hover:bg-slate-800 active:scale-[0.98] transition-transform font-bold text-sm flex items-center justify-center gap-2">
                    <i data-lucide="plus" class="w-4 h-4"></i> Yeni Ekle
                </button>
                <button onclick="toggleDataMenu()" class="bg-slate-100 text-slate-700 rounded font-bold text-sm flex items-center justify-center border border-slate-200 active:bg-slate-200">
                    <i data-lucide="settings-2" class="w-4 h-4"></i> Ayarlar
                </button>
            </div>

            <!-- Gizli Menü -->
            <div id="data-menu" class="hidden bg-slate-50 rounded p-2 border border-slate-200 grid grid-cols-3 gap-2 text-xs">
                <button onclick="exportData()" class="flex flex-col items-center justify-center py-2 bg-white border rounded text-slate-600">
                    <i data-lucide="download" class="w-4 h-4 mb-1"></i> Yedek Al
                </button>
                <label class="flex flex-col items-center justify-center py-2 bg-white border rounded text-slate-600 cursor-pointer">
                    <i data-lucide="upload" class="w-4 h-4 mb-1"></i> Yükle
                    <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
                </label>
                <button onclick="confirmReset()" class="flex flex-col items-center justify-center py-2 bg-red-50 border border-red-100 rounded text-red-600">
                    <i data-lucide="trash-2" class="w-4 h-4 mb-1"></i> Sıfırla
                </button>
            </div>
        </div>
    </div>

    <!-- EKLEME MODALI -->
    <div id="add-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end sm:items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-xl p-5 shadow-2xl modal-enter">
            <h3 class="font-brand font-bold text-xl mb-4 text-black">Yeni Eczane Ekle</h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">BÖLGE / BRICK</label>
                    <input type="text" id="new-region" list="region-list" placeholder="Örn: ORDU MERKEZ -1" class="w-full p-3 border border-slate-300 rounded focus:outline-none focus:border-black font-medium">
                    <datalist id="region-list"></datalist>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">ECZANE ADI</label>
                    <input type="text" id="new-name" placeholder="Örn: Yeni Eczane" class="w-full p-3 border border-slate-300 rounded focus:outline-none focus:border-black font-medium">
                </div>
                <div class="flex gap-2 mt-4 pt-2">
                    <button onclick="closeAddModal()" class="flex-1 py-3 border border-slate-300 rounded text-slate-600 font-bold">İptal</button>
                    <button onclick="addNewPharmacy()" class="flex-1 py-3 bg-black text-white rounded font-bold hover:bg-slate-800">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // GÜNCEL LİSTE (Yüklenen dosyadan alındı)
        const INITIAL_LIST = [
            {"gln":"8680001156580","name":"FATİH ECZANESİ","region":"ORDU MERKEZ -1"},
            {"gln":"8680001203062","name":"ŞİMŞEK ECZANESİ","region":"ORDU MERKEZ -1"},
            {"gln":"8680001165636","name":"KAYAHAN ECZANESİ","region":"ORDU MERKEZ -1"},
            {"gln":"8680001154135","name":"ERGÜL ECZANESİ","region":"ORDU MERKEZ -1"},
            {"gln":"8680001554102","name":"ALTINORDU ECZANESİ","region":"ORDU MERKEZ -1"},
            {"gln":"8680001428342","name":"DOĞA ECZANESİ","region":"ORDU MERKEZ -1"},
            {"gln":"8680001627868","name":"GÜNEŞ ECZANESİ","region":"ORDU MERKEZ -1"},
            {"gln":"8680001148165","name":"NAZ ECZANESİ","region":"ORDU MERKEZ -2"},
            {"gln":"8680001150304","name":"ORDU ECZANESİ","region":"ORDU MERKEZ -2"},
            {"gln":"8680001141944","name":"KOÇYİĞİT ECZANESİ","region":"ORDU MERKEZ -2"},
            {"gln":"8680001153336","name":"DURU ECZANESİ","region":"ORDU MERKEZ -3"},
            {"gln":"8680001420681","name":"ONUR ECZANESİ","region":"ORDU MERKEZ -3"},
            {"gln":"8680001494163","name":"ZEYNEP ECZANESİ","region":"ORDU MERKEZ -3"},
            {"gln":"8680001570485","name":"FIRAT ECZANESİ","region":"ORDU MERKEZ -3"},
            {"gln":"8680001563258","name":"MERT GERÇEKER ECZ.","region":"ORDU MERKEZ -3"},
            {"gln":"8680001632466","name":"TUGCAN ECZANESI","region":"ORDU MERKEZ -3"},
            {"gln":"8680001679072","name":"NİSAN ECZANESİ","region":"ORDU MERKEZ -3"},
            {"gln":"8680001648450","name":"AŞKAN ECZANESİ","region":"ORDU MERKEZ -3"},
            {"gln":"8680001141746","name":"ALTAŞ ECZANESİ","region":"ORDU MERKEZ -3"},
            {"gln":"8680001636570","name":"ÇÖREK OTU ECZANESİ","region":"ORDU FATSA"},
            {"gln":"8680001277230","name":"MERKEZ ECZANESİ","region":"ORDU FATSA"},
            {"gln":"8680001252817","name":"AKAR ECZANESİ","region":"ORDU FATSA"},
            {"gln":"8680001389414","name":"BESTE ECZANESİ","region":"ORDU FATSA"},
            {"gln":"8680001490844","name":"FATSA ECZANESİ","region":"ORDU FATSA"},
            {"gln":"8680001277308","name":"NOKTA ECZANESİ","region":"ORDU FATSA"},
            {"gln":"8680001417810","name":"ÇAKIROĞLU ECZANESİ","region":"ORDU UNYE"},
            {"gln":"8680001232352","name":"TELCİOĞLU ECZANESİ","region":"ORDU UNYE"},
            {"gln":"8680001150144","name":"ORAL ECZANESİ","region":"ORDU UNYE"},
            {"gln":"8680001657612","name":"NEFES ECZANESİ","region":"ORDU UNYE"},
            {"gln":"8680001163564","name":"KARADENİZ ECZANESİ","region":"ORDU DOGU ILCELER"},
            {"gln":"8680001163717","name":"KARADENİZ ECZANESİ (2)","region":"ORDU DOGU ILCELER"},
            {"gln":"8680001460397","name":"IRMAK ECZANESİ","region":"ORDU DOGU ILCELER"},
            {"gln":"8680001713677","name":"YENİ MEDRESEÖNÜ ECZ.","region":"ORDU DOGU ILCELER"},
            {"gln":"8680001213276","name":"MESUDİYE ECZANESİ","region":"ORDU DOGU ILCELER"},
            {"gln":"8680001726905","name":"DEVA ECZANESİ","region":"ORDU DOGU ILCELER"},
            {"gln":"8680001202294","name":"ŞAHİN ECZANESİ","region":"ORDU DOGU ILCELER"},
            {"gln":"8680001233144","name":"ULUBEY ECZANESİ","region":"ORDU DOGU ILCELER"},
            {"gln":"8680001709571","name":"LOTUS ECZANESİ","region":"ORDU DOGU ILCELER"},
            {"gln":"8680001753178","name":"LOTUS ECZANESİ (2)","region":"ORDU DOGU ILCELER"},
            {"gln":"8680001428854","name":"ÇAĞLA ECZANESİ","region":"ORDU DOGU ILCELER"},
            {"gln":"8680001157914","name":"GÜRGENTEPE ECZANESİ","region":"ORDU GUNEY ILCELER -1"},
            {"gln":"USER_1764835117779","name":"PARK ECZANESI ","region":"ORDU MERKEZ -1"}
        ];

        // GÜNCEL TRACKING VERİSİ (Yüklenen dosyadan alındı)
        const PRELOADED_TRACK = {
            "8680001636570":{"visited":true,"ordered":false,"followUp":"waiting"},
            "8680001252817":{"visited":true,"ordered":false,"followUp":"waiting"},
            "8680001490844":{"visited":true,"ordered":false,"followUp":"later"},
            "8680001277308":{"visited":true,"ordered":false,"followUp":"waiting"},
            "8680001417810":{"visited":true,"ordered":false},
            "8680001232352":{"visited":true,"ordered":false},
            "8680001150144":{"visited":true,"ordered":false,"followUp":"later"},
            "8680001657612":{"visited":true,"ordered":true,"followUp":"","amount":"666"},
            "8680001141746":{"visited":true,"ordered":true,"amount":"8364"},
            "8680001156580":{"visited":true,"ordered":true,"amount":"8711"},
            "8680001203062":{"visited":true,"ordered":false,"followUp":""},
            "8680001154135":{"visited":true,"ordered":false},
            "8680001563258":{"visited":true,"ordered":true,"amount":"2321"},
            "8680001153336":{"visited":true,"ordered":false},
            "8680001163564":{"visited":true,"ordered":true,"amount":"27731"},
            "8680001420681":{"visited":true,"ordered":false,"followUp":"waiting"},
            "8680001632466":{"visited":true,"ordered":false},
            "8680001648450":{"visited":true,"ordered":false},
            "8680001570485":{"visited":true,"ordered":true,"amount":"733","note":"Dalin"},
            "8680001713677":{"visited":true,"ordered":false,"followUp":"waiting"},
            "8680001726905":{"visited":true,"ordered":false,"followUp":"later"},
            "8680001202294":{"visited":true,"ordered":false},
            "8680001163717":{"visited":true,"ordered":true,"amount":"5845"},
            "8680001460397":{"visited":true,"ordered":false,"followUp":"waiting"},
            "8680001233144":{"visited":true,"ordered":false},
            "8680001709571":{"visited":false,"ordered":false},
            "8680001753178":{"visited":true,"ordered":true,"amount":"1466"},
            "8680001277230":{"visited":true,"ordered":false},
            "8680001389414":{"visited":true,"ordered":false},
            "USER_1764835117779":{"visited":true,"ordered":true,"amount":"34035"}
        };

        // State & LocalStorage
        let pharmacyList = JSON.parse(localStorage.getItem('genveon_list_v6')) || INITIAL_LIST;
        let trackingData = JSON.parse(localStorage.getItem('genveon_track_v6')) || PRELOADED_TRACK;
        
        let expandedRegions = {};
        let expandedDetails = {};

        // --- CORE FUNCTIONS ---
        function saveData() {
            localStorage.setItem('genveon_track_v6', JSON.stringify(trackingData));
            localStorage.setItem('genveon_list_v6', JSON.stringify(pharmacyList));
        }

        function saveAndRender() {
            saveData();
            renderApp();
        }

        // --- MODAL ---
        function openAddModal() {
            document.getElementById('add-modal').classList.remove('hidden');
            const regions = [...new Set(pharmacyList.map(item => item.region))];
            document.getElementById('region-list').innerHTML = regions.map(r => `<option value="${r}">`).join('');
        }

        function closeAddModal() {
            document.getElementById('add-modal').classList.add('hidden');
        }

        function addNewPharmacy() {
            const name = document.getElementById('new-name').value;
            const region = document.getElementById('new-region').value;
            if (!name || !region) return alert("Bilgileri eksiksiz girin.");
            const newGln = "USER_" + Date.now();
            pharmacyList.push({ gln: newGln, name: name.toUpperCase(), region: region.toUpperCase() });
            saveAndRender();
            closeAddModal();
            if(!expandedRegions[region.toUpperCase()]) toggleRegion(region.toUpperCase());
        }

        // --- UI ACTIONS ---
        function toggleRegion(region) {
            expandedRegions[region] = !expandedRegions[region];
            renderApp();
        }

        function toggleDetails(gln) {
            expandedDetails[gln] = !expandedDetails[gln];
            renderApp();
        }

        function handleInput(gln, field, value) {
            if (!trackingData[gln]) trackingData[gln] = {};
            trackingData[gln][field] = value;
            saveData();
            updateHeaderStats();
        }

        function updateDalin(gln, change) {
            if (!trackingData[gln]) trackingData[gln] = {};
            const current = parseInt(trackingData[gln].dalin || 0);
            const newValue = Math.max(0, current + change);
            trackingData[gln].dalin = newValue;
            saveData();
            updateHeaderStats();
            // Inputu güncelle (Render etmeden)
            const inputEl = document.getElementById(`dalin-input-${gln}`);
            if(inputEl) inputEl.value = newValue;
        }

        function toggleStatus(gln, type) {
            if (!trackingData[gln]) trackingData[gln] = { visited: false, ordered: false };
            trackingData[gln][type] = !trackingData[gln][type];
            if (type === 'ordered' && trackingData[gln].ordered && !trackingData[gln].visited) {
                trackingData[gln].visited = true;
            }
            saveAndRender();
        }

        function toggleFollowUp(gln, type) {
            if (!trackingData[gln]) trackingData[gln] = {};
            trackingData[gln].followUp = trackingData[gln].followUp === type ? '' : type;
            saveAndRender();
        }

        function toggleDataMenu() {
            document.getElementById('data-menu').classList.toggle('hidden');
        }

        // --- STATS & RENDER ---
        function updateHeaderStats() {
            let visitedCount = 0;
            let totalAmount = 0;
            let dalinTotal = 0;

            Object.values(trackingData).forEach(item => {
                if (item.visited) visitedCount++;
                if (item.ordered) totalAmount += parseFloat(item.amount) || 0;
                if (item.dalin) dalinTotal += parseInt(item.dalin) || 0;
            });

            const totalCount = pharmacyList.length;
            const visitPercentage = totalCount === 0 ? 0 : Math.round((visitedCount / totalCount) * 100);

            // Update DOM
            document.getElementById('total-amount').innerText = totalAmount.toLocaleString('tr-TR');
            document.getElementById('visit-count').innerText = `${visitedCount}/${totalCount}`;
            document.getElementById('visit-percentage').innerText = `%${visitPercentage}`;
            document.getElementById('dalin-total').innerText = dalinTotal;

            // Progress Bar Renk Mantığı
            const bar = document.getElementById('progress-bar');
            bar.style.width = `${visitPercentage}%`;
            
            if(visitPercentage < 33) {
                bar.className = "h-2.5 rounded-full transition-all duration-500 ease-out bg-red-500";
            } else if (visitPercentage < 66) {
                bar.className = "h-2.5 rounded-full transition-all duration-500 ease-out bg-yellow-500";
            } else {
                bar.className = "h-2.5 rounded-full transition-all duration-500 ease-out bg-green-500";
            }
        }

        function exportData() {
            const dataToExport = { list: pharmacyList, track: trackingData };
            const dataStr = JSON.stringify(dataToExport);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', `Genveon_Yedek_V6_${new Date().toLocaleDateString()}.json`);
            linkElement.click();
            toggleDataMenu();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const parsed = JSON.parse(e.target.result);
                    if(parsed.list && parsed.track) {
                        pharmacyList = parsed.list;
                        trackingData = parsed.track;
                        saveAndRender();
                        alert("Yedek başarıyla yüklendi!");
                    } else {
                        alert("Uyumsuz dosya formatı.");
                    }
                } catch(err) { alert("Dosya okunamadı."); }
            };
            reader.readAsText(file);
            toggleDataMenu();
        }

        function confirmReset() {
            if(confirm("Tüm verileri silip varsayılana dönmek istediğine emin misin?")) {
                localStorage.removeItem('genveon_list_v6');
                localStorage.removeItem('genveon_track_v6');
                location.reload();
            }
        }

        // --- ANA RENDER FONKSİYONU ---
        function renderApp() {
            const container = document.getElementById('app-container');
            const groupedData = {};
            pharmacyList.forEach(item => {
                if (!groupedData[item.region]) groupedData[item.region] = [];
                groupedData[item.region].push(item);
            });
            
            updateHeaderStats();
            container.innerHTML = '';
            const sortedRegions = Object.keys(groupedData).sort();

            for (const region of sortedRegions) {
                const items = groupedData[region];
                
                let regionVisited = 0;
                let regionOrdered = 0;
                let regionTotalAmount = 0;
                
                items.forEach(i => { 
                    const d = trackingData[i.gln];
                    if (d?.visited) regionVisited++;
                    if (d?.ordered) {
                        regionOrdered++;
                        regionTotalAmount += parseFloat(d.amount) || 0;
                    }
                });

                const isAllVisited = regionVisited === items.length && items.length > 0;
                
                // Stil
                let headerClass = "bg-orange-50 border-orange-100 text-orange-900";
                let barClass = "bg-orange-500";
                
                if (regionVisited === 0) {
                    headerClass = "bg-white border-slate-200 text-slate-800";
                    barClass = "bg-slate-400";
                } else if (isAllVisited) {
                    headerClass = "bg-green-50 border-green-100 text-green-900";
                    barClass = "bg-green-600";
                }

                const isOpen = expandedRegions[region];
                
                const regionHtml = document.createElement('div');
                regionHtml.className = `rounded-xl shadow-sm border overflow-hidden ${headerClass}`;
                
                regionHtml.innerHTML = `
                    <button onclick="toggleRegion('${region}')" class="w-full text-left p-4 transition-colors hover:opacity-95">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="font-bold text-lg leading-tight uppercase tracking-tight">${region}</h3>
                                ${regionTotalAmount > 0 ? `<div class="font-black text-xl mt-1 tracking-tight">₺${regionTotalAmount.toLocaleString('tr-TR')}</div>` : ''}
                            </div>
                            <i data-lucide="${isOpen ? 'chevron-up' : 'chevron-down'}" class="opacity-50 w-6 h-6"></i>
                        </div>
                        
                        <div class="flex items-center gap-3">
                            <div class="flex-1 bg-white/50 rounded-full h-2 overflow-hidden backdrop-blur-sm border border-black/5">
                                <div class="${barClass} h-2 rounded-full" style="width: ${(regionVisited/items.length)*100}%"></div>
                            </div>
                            <span class="text-xs font-bold opacity-70 whitespace-nowrap">${regionVisited}/${items.length} Ziyaret</span>
                        </div>
                    </button>
                `;

                if (isOpen) {
                    const listContainer = document.createElement('div');
                    listContainer.className = "divide-y divide-slate-100 bg-white border-t border-slate-100";

                    items.forEach(pharmacy => {
                        const data = trackingData[pharmacy.gln] || {};
                        const isDetailsOpen = expandedDetails[pharmacy.gln];

                        // Rozetler
                        let badges = '';
                        if (!isDetailsOpen) {
                            if (data.followUp === 'later') badges += `<span class="bg-orange-100 text-orange-700 text-[9px] px-1.5 py-0.5 rounded font-bold ml-2">SONRA</span>`;
                            if (data.followUp === 'waiting') badges += `<span class="bg-purple-100 text-purple-700 text-[9px] px-1.5 py-0.5 rounded font-bold ml-2">DÖNÜŞ</span>`;
                            if (data.dalin && data.dalin > 0) badges += `<span class="bg-yellow-100 text-yellow-800 text-[9px] px-1.5 py-0.5 rounded font-bold ml-2">DALİN: ${data.dalin}</span>`;
                        }

                        // Tutar Gösterimi (Yanında istendiği için name satırına alıyorum)
                        let amountBadge = '';
                        if (data.ordered && data.amount) {
                            amountBadge = `<span class="bg-emerald-100 text-emerald-700 border border-emerald-200 text-[10px] font-black px-2 py-0.5 rounded ml-2 shadow-sm">₺${parseFloat(data.amount).toLocaleString('tr-TR')}</span>`;
                        }

                        // İsim Stili: Ziyaret edildiyse yeşil, çizgi YOK
                        const nameClass = data.visited ? 'text-green-600' : 'text-slate-900';

                        const itemDiv = document.createElement('div');
                        itemDiv.className = "flex flex-col";
                        itemDiv.innerHTML = `
                            <div class="p-3.5 flex items-center justify-between gap-3">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center flex-wrap">
                                        <div class="font-bold text-sm truncate ${nameClass}">${pharmacy.name}</div>
                                        ${amountBadge}
                                        ${badges}
                                    </div>
                                </div>
                                
                                <div class="flex gap-2 shrink-0">
                                    <button onclick="toggleStatus('${pharmacy.gln}', 'visited')" class="w-10 h-10 rounded border flex items-center justify-center transition-all active:scale-95 ${data.visited ? 'bg-green-600 border-green-600 text-white shadow-md' : 'bg-white border-slate-200 text-slate-300'}">
                                        <i data-lucide="check" class="w-5 h-5"></i>
                                    </button>
                                    
                                    <button onclick="toggleStatus('${pharmacy.gln}', 'ordered')" class="w-10 h-10 rounded border flex items-center justify-center transition-all active:scale-95 ${data.ordered ? 'bg-blue-600 border-blue-600 text-white shadow-md' : 'bg-white border-slate-200 text-slate-300'}">
                                        <i data-lucide="shopping-cart" class="w-4 h-4"></i>
                                    </button>

                                    <button onclick="toggleDetails('${pharmacy.gln}')" class="w-9 h-10 rounded border flex items-center justify-center transition-all active:scale-95 ${isDetailsOpen || data.note || data.followUp || (data.dalin>0) ? 'bg-slate-100 border-slate-300 text-slate-600' : 'bg-white border-slate-200 text-slate-300'}">
                                        <i data-lucide="chevron-down" class="w-4 h-4 transition-transform ${isDetailsOpen ? 'rotate-180' : ''}"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="bg-slate-50 px-3 border-b border-slate-100 overflow-hidden transition-height ${data.ordered || isDetailsOpen ? 'pb-3 max-h-[500px]' : 'max-h-0 border-0'}">
                                ${data.ordered ? `
                                    <div class="pt-2 mb-2">
                                        <div class="relative">
                                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 font-bold text-sm">₺</span>
                                            <input type="number" placeholder="Sipariş Tutarı" value="${data.amount || ''}" oninput="handleInput('${pharmacy.gln}', 'amount', this.value)" class="w-full pl-8 pr-3 py-2.5 text-base font-bold text-green-700 border border-slate-300 rounded focus:outline-none focus:border-green-600 bg-white shadow-sm">
                                        </div>
                                    </div>
                                ` : ''}

                                ${isDetailsOpen ? `
                                    <div class="space-y-3 pt-1">
                                        <!-- DURUM BUTONLARI -->
                                        <div class="flex gap-2">
                                            <button onclick="toggleFollowUp('${pharmacy.gln}', 'later')" class="flex-1 flex items-center justify-center gap-1.5 py-2.5 px-2 rounded border text-[10px] font-bold transition-colors ${data.followUp === 'later' ? 'bg-orange-100 border-orange-200 text-orange-700' : 'bg-white border-slate-200 text-slate-500'}">
                                                <i data-lucide="clock" class="w-3.5 h-3.5"></i> SONRA UĞRA
                                            </button>
                                            <button onclick="toggleFollowUp('${pharmacy.gln}', 'waiting')" class="flex-1 flex items-center justify-center gap-1.5 py-2.5 px-2 rounded border text-[10px] font-bold transition-colors ${data.followUp === 'waiting' ? 'bg-purple-100 border-purple-200 text-purple-700' : 'bg-white border-slate-200 text-slate-500'}">
                                                <i data-lucide="alert-circle" class="w-3.5 h-3.5"></i> DÖNÜŞ BEKLENİYOR
                                            </button>
                                        </div>
                                        
                                        <!-- NOT ALANI -->
                                        <textarea placeholder="Ziyaret notu ekle..." oninput="handleInput('${pharmacy.gln}', 'note', this.value)" class="w-full p-3 text-sm border border-slate-300 rounded focus:outline-none focus:border-black bg-white min-h-[70px]">${data.note || ''}</textarea>

                                        <!-- DALİN SAYACI (YENİ) -->
                                        <div class="bg-yellow-50 rounded-lg p-3 border border-yellow-200 flex items-center justify-between">
                                            <span class="font-bold text-yellow-800 text-xs uppercase">Dalin Adet</span>
                                            <div class="flex items-center gap-3">
                                                <button onclick="updateDalin('${pharmacy.gln}', -1)" class="w-8 h-8 flex items-center justify-center bg-white rounded border border-yellow-300 text-yellow-700 font-bold active:bg-yellow-100">-</button>
                                                <input id="dalin-input-${pharmacy.gln}" type="number" readonly value="${data.dalin || 0}" class="w-10 text-center bg-transparent font-black text-lg text-yellow-900">
                                                <button onclick="updateDalin('${pharmacy.gln}', 1)" class="w-8 h-8 flex items-center justify-center bg-white rounded border border-yellow-300 text-yellow-700 font-bold active:bg-yellow-100">+</button>
                                            </div>
                                        </div>
                                        
                                        <!-- KAPAT BUTONU -->
                                        <button onclick="toggleDetails('${pharmacy.gln}')" class="w-full py-2 bg-slate-100 text-slate-500 text-xs font-bold rounded flex items-center justify-center gap-1 hover:bg-slate-200">
                                            <i data-lucide="chevron-up" class="w-3 h-3"></i> Detayı Kapat
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                        listContainer.appendChild(itemDiv);
                    });
                    regionHtml.appendChild(listContainer);
                }
                container.appendChild(regionHtml);
            }
            lucide.createIcons();
        }

        renderApp();
    </script>
</body>
</html>

